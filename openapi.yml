openapi: 3.1.1
info:
  title: User Management API
  description: ユーザーの登録と更新を行うAPI定義
  version: 1.0.0

servers:
  - url: http://localhost:8080/api/v1
    description: 開発サーバー

paths:
  # --- ユーザー登録 (POST) ---
  /users:
    post:
      tags:
        - Users
      summary: 新規ユーザーの登録
      description: 新しいユーザーアカウントを作成します。
      operationId: createUser
      requestBody:
        description: ユーザー作成に必要な情報
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreateRequest' # 登録用スキーマを参照
      responses:
        "201":
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse' # 登録されたユーザー情報を返却
        "400":
          $ref: '#/components/responses/BadRequest'
        "422":
          $ref: '#/components/responses/UnprocessableEntity'

  # --- ユーザー更新 (PATCH) ---
  /users/{userId}:
    patch:
      tags:
        - Users
      summary: 既存ユーザー情報の部分更新
      description: 指定されたユーザーIDの情報を更新します。更新したいフィールドのみを送信します。
      operationId: updateUser
      parameters:
        - name: userId
          in: path
          description: 更新対象のユーザーID
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        description: 更新するユーザー情報（部分更新）
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest' # 更新用スキーマを参照
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse' # 更新後のユーザー情報を返却
        "400":
          $ref: '#/components/responses/BadRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "422":
          $ref: '#/components/responses/UnprocessableEntity'

components:
  # --- スキーマ定義 ---
  schemas:
    # ユーザー登録リクエスト（POST /users のリクエストボディ）
    UserCreateRequest:
      type: object
      properties:
        username:
          type: string
          description: ユーザー名
          example: tarou.yamada
        email:
          type: string
          format: email
          description: メールアドレス
          example: test@example.com
        password:
          type: string
          description: パスワード
          writeOnly: true # レスポンスには含まれない
      required:
        - username
        - email
        - password

    # ユーザー更新リクエスト（PATCH /users/{userId} のリクエストボディ）
    UserUpdateRequest:
      type: object
      description: 部分更新のため、すべてのプロパティはオプション（requiredなし）
      properties:
        username:
          type: string
          description: ユーザー名
          example: tarou.update
        email:
          type: string
          format: email
          description: メールアドレス
          example: new_test@example.com
        # パスワードは別のエンドポイントで更新する設計にすることが多い
      
    # ユーザー応答（成功レスポンスボディ）
    UserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: ユーザーID (システムが付与)
          readOnly: true
          example: 101
        username:
          type: string
          description: ユーザー名
          example: tarou.yamada
        email:
          type: string
          format: email
          description: メールアドレス
          example: test@example.com
        createdAt:
          type: string
          format: date-time
          description: 作成日時
          readOnly: true
      required:
        - id
        - username
        - email
        - createdAt
        
  # --- レスポンス定義 ---
  responses:
    BadRequest:
      description: 不正なリクエスト (例: 必須フィールド欠落)
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Invalid request data."
    NotFound:
      description: 対象リソースが見つからない (例: 存在しないユーザーID)
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "User not found."
    UnprocessableEntity:
      description: 入力データ検証エラー (例: メールアドレスの形式不正、ユーザー名が既に存在する)
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Validation failed."
              details:
                type: array
                items:
                  type: string
                  example: "email: is already taken"